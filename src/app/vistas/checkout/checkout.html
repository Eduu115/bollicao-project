<div class="checkout-container container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            <!-- Breadcrumb / Stepper -->
            <div class="checkout-breadcrumb mb-5 d-flex justify-content-center align-items-center">
                <span class="step-link cursor-pointer d-flex align-items-center" [class.active]="currentStep === 1"
                    [class.completed]="currentStep > 1" (click)="goToStep(1)">
                    Método de envío
                </span>
                <i class="fa-solid fa-chevron-right mx-3 step-chevron"></i>
                <span class="step-link cursor-pointer d-flex align-items-center" [class.active]="currentStep === 2"
                    [class.completed]="currentStep > 2" [class.text-muted]="currentStep < 2"
                    [class.disabled]="currentStep < 2 && currentStep !== 2 && (currentStep !== 1 || selectedShipping === null)"
                    (click)="goToStep(2)">
                    Método de pago
                </span>
                <i class="fa-solid fa-chevron-right mx-3 step-chevron"></i>
                <span class="step-link d-flex align-items-center" [class.active]="currentStep === 3"
                    [class.text-muted]="currentStep < 3">
                    Resumen
                </span>
            </div>

            <!-- PASO 1: MÉTODO DE ENVÍO -->
            @if (currentStep === 1) {
            <div class="step-container fade-in">
                <h2 class="fw-bold mb-3 section-title text-center">Elige un método de envío</h2>
                <p class="text-muted mb-4 small-notice text-center border-0 px-3">
                    Selecciona cómo prefieres recibir tus deliciosos postres.
                </p>

                <div class="shipping-options mb-4">
                    <!-- Opción 1 -->
                    <div class="shipping-card" [class.active]="selectedShipping === 1" (click)="selectShipping(1)">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold method-title">Recogida en Tienda</span>
                            <span class="fw-bold text-success method-price">GRATIS</span>
                        </div>
                        <span class="text-muted method-desc">Recoge tu pedido personalmente en nuestro local</span>
                    </div>

                    <!-- Opción 2 -->
                    <div class="shipping-card mt-3" [class.active]="selectedShipping === 2" (click)="selectShipping(2)">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold method-title">Envío a Domicilio</span>
                            <span class="fw-bold method-price">4,00 €</span>
                        </div>
                        <span class="text-muted method-desc">Recibe tus dulces cómodamente en casa</span>
                    </div>
                </div>

                <div class="d-flex justify-content-center mt-5">
                    <button class="btn btn-continuar px-5 py-3" [disabled]="selectedShipping === null"
                        (click)="nextStep()">CONTINUAR A PAGO</button>
                </div>
            </div>
            }

            <!-- PASO 2: MÉTODO DE PAGO -->
            @if (currentStep === 2) {
            <div class="step-container fade-in">
                <h2 class="fw-bold mb-3 section-title text-center">Elige un método de pago</h2>
                <p class="text-muted mb-4 small-notice text-center border-0 px-3">
                    Realiza tu pago de forma 100% segura.
                </p>

                <div class="shipping-options mb-4">
                    <div class="shipping-card payment-card" [class.active]="selectedPayment === 1"
                        (click)="selectPayment(1)">
                        <div class="d-flex align-items-center mb-1">
                            <i class="fa-brands fa-cc-visa fs-3 me-3 text-primary"></i>
                            <i class="fa-brands fa-cc-mastercard fs-3 me-3 text-warning"></i>
                            <span class="fw-bold method-title flex-grow-1">Tarjeta de crédito o débito</span>
                        </div>

                        <!-- Accordion for Credit Card Details -->
                        @if (selectedPayment === 1) {
                        <div class="mt-3 pt-3 border-top border-secondary fade-in" (click)="$event.stopPropagation()">
                            <div class="mb-3">
                                <label class="form-label text-muted small mb-1">Número de tarjeta</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary"
                                    placeholder="0000 0000 0000 0000">
                            </div>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted small mb-1">Caducidad</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary"
                                        placeholder="MM/AA">
                                </div>
                                <div class="col-6 mb-3">
                                    <label class="form-label text-muted small mb-1">CVV</label>
                                    <input type="text" class="form-control bg-dark text-light border-secondary"
                                        placeholder="123">
                                </div>
                            </div>
                            <div class="mb-2">
                                <label class="form-label text-muted small mb-1">Titular de la tarjeta</label>
                                <input type="text" class="form-control bg-dark text-light border-secondary"
                                    placeholder="Nombre completo">
                            </div>
                        </div>
                        }
                    </div>

                    <div class="shipping-card payment-card mt-3" [class.active]="selectedPayment === 2"
                        (click)="selectPayment(2)">
                        <div class="d-flex align-items-center mb-1">
                            <i class="fa-brands fa-paypal fs-3 me-3 text-info"></i>
                            <span class="fw-bold method-title flex-grow-1">PayPal</span>
                        </div>
                    </div>

                    <div class="shipping-card payment-card mt-3" [class.active]="selectedPayment === 3"
                        (click)="selectPayment(3)">
                        <div class="d-flex align-items-center mb-1">
                            <i class="fa-solid fa-money-bill-transfer fs-3 me-3 text-success"></i>
                            <span class="fw-bold method-title flex-grow-1">Bizum</span>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center mt-5">
                    <button class="btn btn-continuar px-5 py-3" [disabled]="selectedPayment === null"
                        (click)="nextStep()">REVISAR PEDIDO</button>
                </div>
            </div>
            }

            <!-- PASO 3: RESUMEN FINAL -->
            @if (currentStep === 3) {
            <div class="step-container fade-in">
                <h2 class="fw-bold mb-4 section-title text-center">Resumen de tu pedido</h2>

                <div class="summary-box-standalone p-4 rounded mb-4 shadow-sm border border-rosa-pastel">
                    <h5 class="fw-bold mb-4 border-bottom border-secondary pb-2">Artículos ({{ items.length }})</h5>

                    <div class="summary-items mb-4">
                        @for (item of items; track item.producto._id) {
                        <div class="summary-item d-flex mb-3 align-items-center">
                            <div class="item-details flex-grow-1 d-flex flex-column justify-content-center">
                                <p class="item-name mb-1 fw-bold">{{ item.producto.nombre }}</p>
                                <span class="item-meta text-muted small mb-1">Cantidad: {{ item.cantidad }}</span>
                            </div>
                            <span class="price-current text-rosa fw-bold">{{ item.producto.precio * item.cantidad | number:'1.2-2' }} €</span>
                        </div>
                        }
                    </div>

                    <h5 class="fw-bold mb-3 border-bottom border-secondary pb-2 mt-4">Totales</h5>
                    <div class="summary-totals">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="text-muted">Subtotal artículos</span>
                            <span class="fw-semibold">{{ getSubtotal() | number:'1.2-2' }} €</span>
                        </div>
                        <div class="d-flex justify-content-between mb-3 border-bottom border-secondary pb-3">
                            <span class="text-muted">Gastos de envío</span>
                            <span class="fw-semibold">{{ getShippingCost() > 0 ? (getShippingCost() | number:'1.2-2') +
                                ' €' : 'GRATIS' }}</span>
                        </div>
                        <div class="d-flex justify-content-between mt-3 align-items-center">
                            <span class="fw-bold fs-5">TOTAL <small class="text-muted fw-normal fs-6">(Impuestos
                                    incluidos)</small></span>
                            <span class="fw-bold fs-3 text-rosa">{{ getTotal() | number:'1.2-2' }} €</span>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center mt-4">
                    <button class="btn btn-comprar px-5 py-3 fs-5" (click)="comprar()" [disabled]="comprando">
                        @if (comprando) {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>Procesando...
                        } @else {
                            COMPRAR AHORA
                        }
                    </button>
                </div>
                @if (errorCompra) {
                <div class="alert alert-danger mt-3 text-center" role="alert">
                    {{ errorCompra }}
                </div>
                }
            </div>
            }

        </div>
    </div>
</div>